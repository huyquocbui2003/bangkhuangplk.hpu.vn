<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S·ªï Ghi B√†i - B√ÇNG KHU√ÇNG</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      /* ========================================================================================================= */
      /* C√ÄI ƒê·∫∂T BI·∫æN V√Ä FONT CHUNG */
      /* ========================================================================================================= */
      :root {
        --primary-color: #d81b60; /* M√†u ch√≠nh: ƒê·ªè t√≠m */
        --secondary-color: #ff80ab; /* M√†u ph·ª•: H·ªìng nh·∫°t */
        --background-light: #e0f7fa; /* N·ªÅn s√°ng */
        --background-dark: #fce4ec; /* N·ªÅn t·ªëi */
        --text-color: #333; /* M√†u ch·ªØ ch√≠nh */
        --card-bg: #fff; /* N·ªÅn c·ªßa c√°c th·∫ª */
        --border-radius-large: 10px; /* Bo g√≥c l·ªõn */
        --border-radius-small: 6px; /* Bo g√≥c nh·ªè */
        --box-shadow-main: 0 4px 20px rgba(0, 0, 0, 0.1); /* Hi·ªáu ·ª©ng ƒë·ªï b√≥ng ch√≠nh */
        --sidebar-width: 250px;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(
          135deg,
          var(--background-light),
          var(--background-dark)
        );
        margin: 0;
        padding: 0;
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* ========================================================================================================= */
      /* THANH ƒêI·ªÄU H∆Ø·ªöNG V√Ä C√ÅC N√öT CHUNG */
      /* ========================================================================================================= */
      .top-buttons-container {
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        gap: 10px;
        padding: 10px;
        background-color: var(--card-bg);
        box-shadow: var(--box-shadow-main);
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
      }

      @media (min-width: 768px) {
        .top-buttons-container {
          justify-content: flex-start;
        }
      }

      .nav-button {
        display: flex;
        align-items: center;
        background: linear-gradient(to right, var(--secondary-color), #f48fb1);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
      }
      .nav-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .nav-button.active {
        background: linear-gradient(to right, var(--primary-color), #f06292);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      /* ========================================================================================================= */
      /* B·ªê C·ª§C CH√çNH (SIDEBAR + N·ªòI DUNG) */
      /* ========================================================================================================= */
      .main-layout {
        display: flex;
        flex: 1;
        padding-top: 20px;
      }

      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
        }
      }

      /* ========================================================================================================= */
      /* THANH SIDEBAR CHO M√îN H·ªåC */
      /* ========================================================================================================= */
      .sidebar {
        width: var(--sidebar-width);
        min-width: 200px;
        background-color: #fff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: sticky;
        top: 60px;
        height: calc(100vh - 80px);
        overflow-y: auto;
      }

      @media (max-width: 768px) {
        .sidebar {
          position: static;
          height: auto;
          width: 100%;
          min-width: unset;
          margin-bottom: 20px;
        }
      }

      .sidebar h3 {
        margin-top: 0;
        text-align: center;
      }

      .subject-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
      }
      .subject-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        transition: background-color 0.2s;
        margin-bottom: 5px;
        background-color: var(--background-dark);
      }
      .subject-item:hover {
        background-color: var(--background-light);
      }
      .subject-item.active {
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
      }
      .subject-item.active .subject-actions button {
        color: white;
      }
      .subject-name {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .subject-actions button {
        background: none;
        border: none;
        color: var(--primary-color);
        font-size: 1em;
        margin-left: 5px;
        cursor: pointer;
        opacity: 0.7;
      }
      .subject-actions button:hover {
        opacity: 1;
      }
      .add-subject-button {
        width: 100%;
      }

      /* ========================================================================================================= */
      /* KHU V·ª∞C N·ªòI DUNG CH√çNH (GHI CH√ö) */
      /* ========================================================================================================= */
      .main-content-area {
        flex: 1;
        padding: 0 20px 20px;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
      }

      .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: var(--border-radius-large);
        box-shadow: var(--box-shadow-main);
      }

      .main-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 20px;
      }
      .main-title i {
        margin: 0 5px;
        color: var(--secondary-color);
      }
      
      .note-list-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .note-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background-color: var(--background-dark);
        border-radius: var(--border-radius-large);
        cursor: grab; /* Thay ƒë·ªïi con tr·ªè ƒë·ªÉ th·ªÉ hi·ªán c√≥ th·ªÉ k√©o */
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        user-select: none; /* NgƒÉn ch·∫∑n ch·ªçn vƒÉn b·∫£n khi k√©o */
      }
      .note-list-item:hover {
        background-color: var(--background-light);
        transform: translateY(-2px);
      }
      .note-list-item.dragging {
        opacity: 0.5;
        border: 2px dashed var(--primary-color);
      }
      .note-list-item.drag-over {
        border-top: 2px solid var(--primary-color);
      }
      .note-list-item.drag-over-bottom {
        border-bottom: 2px solid var(--primary-color);
      }
      .note-list-item h4 {
        margin: 0;
        font-size: 1.1em;
      }
      .note-list-item p {
        margin: 5px 0 0;
        color: #666;
        font-size: 0.9em;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .note-list-item .date {
        font-size: 0.8em;
        color: #999;
      }

      textarea,
      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin: 5px 0 10px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius-small);
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        min-height: 300px;
        resize: vertical;
      }

      /* ========================================================================================================= */
      /* C√ÅC N√öT ƒêI·ªÄU KHI·ªÇN */
      /* ========================================================================================================= */
      .control-buttons-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      button {
        padding: 10px 16px;
        border: none;
        border-radius: var(--border-radius-small);
        background: linear-gradient(to right, var(--secondary-color), #f48fb1);
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      button:hover {
        background: linear-gradient(to right, var(--primary-color), #f06292);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .button-danger {
        background: #f44336;
      }
      .button-danger:hover {
        background: #d32f2f;
      }

      /* ========================================================================================================= */
      /* ICON V√Ä HI·ªÜU ·ª®NG KH√ÅC */
      /* ========================================================================================================= */
      #clover-reload-icon {
        position: fixed;
        font-size: 2em;
        cursor: grab;
        z-index: 1001;
        bottom: 20px;
        right: 20px;
        user-select: none;
        transition: transform 0.2s ease-in-out;
      }
      #clover-reload-icon:active {
        cursor: grabbing;
      }

      /* Custom modal v√† message box */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
      }
      .modal.visible {
        visibility: visible;
        opacity: 1;
      }
      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: var(--border-radius-large);
        box-shadow: var(--box-shadow-main);
        text-align: center;
        max-width: 90%;
        width: 400px;
      }
      .modal-content p {
        margin: 0 0 15px;
      }
      .modal-content button {
        margin: 5px;
      }
      #editSubjectTitle {
        width: calc(100% - 20px);
      }

      #messageBox {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 10px 20px;
        border-radius: var(--border-radius-large);
        z-index: 2001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      #messageBox.visible {
        opacity: 1;
        visibility: visible;
      }
      
      /* ========================================================================================================= */
      /* FOOTER */
      /* ========================================================================================================= */
      .footer {
        margin-top: auto;
        padding: 20px;
        background: linear-gradient(90deg, #ffe0f0, #e0f7fa);
        font-size: 14px;
        color: #444;
        border-top: 1px solid #ddd;
        text-align: center;
        border-radius: var(--border-radius-large);
      }
      .footer a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: bold;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      .footer .label {
        color: #888;
        font-weight: normal;
      }
      .footer i {
        margin-right: 5px;
        color: var(--primary-color);
      }
      .guide-header {
        cursor: pointer;
        padding: 12px 20px;
        border-radius: 25px;
        background: linear-gradient(135deg, #ff80ab, #f48fb1);
        color: white;
        text-align: center;
        font-weight: bold;
        font-size: 1.1em;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        text-decoration: none;
        margin-bottom: 20px;
      }
      .guide-header:hover {
        background: linear-gradient(135deg, var(--primary-color), #f06292);
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      }
      .guide-header i {
        font-size: 1.3em;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Icon c·ªè ba l√° c√≥ ch·ª©c nƒÉng k√©o -->
    <div id="clover-reload-icon">üçÄ</div>

    <!-- Custom message box ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o -->
    <div id="messageBox"></div>

    <!-- Modal x√°c nh·∫≠n t√πy ch·ªânh (ƒë·ªÉ thay th·∫ø alert) -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <p id="confirmMessage"></p>
        <button id="confirmYes">C√≥</button>
        <button id="confirmNo">Kh√¥ng</button>
      </div>
    </div>
    
    <!-- Modal ch·ªânh s·ª≠a t√™n m√¥n h·ªçc -->
    <div id="editSubjectModal" class="modal">
      <div class="modal-content">
        <h3>Ch·ªânh s·ª≠a t√™n m√¥n h·ªçc</h3>
        <input type="text" id="editSubjectTitle" placeholder="T√™n m√¥n h·ªçc" />
        <button id="saveEditSubjectButton">
          <i class="fas fa-save"></i> L∆∞u
        </button>
        <button id="cancelEditSubjectButton">
          <i class="fas fa-times"></i> H·ªßy
        </button>
      </div>
    </div>

    <!-- ========================================================================================================= -->
    <!--                                 PH·∫¶N THANH ƒêI·ªÄU H∆Ø·ªöNG CH√çNH                                              -->
    <!-- ========================================================================================================= -->
    <div class="top-buttons-container">
      <a class="nav-button" href="giaodien.html">
        <i class="fas fa-home"></i> Home
      </a>
      <a class="nav-button active" href="so_ghi_bai.html">
        <i class="fas fa-book"></i> S·ªï Ghi B√†i
      </a>
      <a
        class="nav-button"
        href="https://drive.google.com/drive/folders/1cR4KwCDcmGDenk9qNfdYm23x5a2c-t3n?usp=sharing"
        target="_blank"
      >
        <i class="fas fa-folder"></i> L∆∞u tr·ªØ
      </a>
      <a class="nav-button" href="calendar.html">
        <i class="fas fa-calendar-alt"></i> L·ªãch
      </a>
      <a class="nav-button" href="contact.html">
        <i class="fas fa-envelope"></i> Li√™n h·ªá
      </a>
      <a class="nav-button" href="trangcanhan.html">
        <i class="fas fa-user-circle"></i> Trang c√° nh√¢n
      </a>
    </div>

    <!-- ========================================================================================================= -->
    <!--                                 B·ªê C·ª§C CH√çNH (SIDEBAR + N·ªòI DUNG)                                        -->
    <!-- ========================================================================================================= -->
    <div class="main-layout">
        <!-- Thanh sidebar cho m√¥n h·ªçc -->
        <div class="sidebar">
            <h3><i class="fas fa-book-reader"></i> M√¥n h·ªçc</h3>
            <button class="nav-button add-subject-button" onclick="addSubject()">
                <i class="fas fa-plus"></i> Th√™m m√¥n h·ªçc
            </button>
            <ul id="subjectList" class="subject-list">
                <!-- Danh s√°ch m√¥n h·ªçc s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
            </ul>
        </div>

        <!-- Khu v·ª±c n·ªôi dung ch√≠nh -->
        <div class="main-content-area">
            <div class="container">
                <h2 id="mainTitle" class="main-title">
                    <i class="fas fa-book-open"></i> Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc
                </h2>

                <!-- Khu v·ª±c hi·ªÉn th·ªã danh s√°ch ghi ch√∫ (hi·ªán khi c√≥ m√¥n h·ªçc ƒë∆∞·ª£c ch·ªçn) -->
                <div id="note-list-view" style="display: none;">
                    <button class="nav-button add-note-button" onclick="createNewNote()">
                        <i class="fas fa-plus"></i> Th√™m ghi ch√∫ m·ªõi
                    </button>
                    <div id="noteList" class="note-list-container">
                        <!-- Danh s√°ch ghi ch√∫ s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
                    </div>
                </div>

                <!-- Khu v·ª±c ch·ªânh s·ª≠a ghi ch√∫ (hi·ªán khi m·ªôt ghi ch√∫ ƒë∆∞·ª£c ch·ªçn/t·∫°o m·ªõi) -->
                <div id="note-editor-view" style="display: none;">
                    <button class="nav-button" onclick="loadNotesForCurrentSubject()">
                        <i class="fas fa-arrow-left"></i> Quay l·∫°i
                    </button>
                    <input type="text" id="noteTitle" placeholder="Ti√™u ƒë·ªÅ b√†i h·ªçc..." />
                    <textarea
                        id="noteContent"
                        placeholder="N·ªôi dung ghi ch√∫..."
                        rows="15"
                    ></textarea>
                    <div class="control-buttons-container">
                        <button onclick="saveNote()">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                        <button onclick="deleteNote()" class="button-danger">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================================================================= -->
    <!--                                               FOOTER                                                    -->
    <!-- ========================================================================================================= -->
    <div class="footer">
      <a href="huong_dan_su_dung.html" class="guide-header">
        <i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
      </a>
      <hr style="border-color: #f48fb1; margin: 20px 0" />
      <div>
        <i class="fas fa-user"></i
        ><span class="label">Designed and developed by:</span>B√πi Qu·ªëc Huy
      </div>
      <div>
        <i class="fab fa-facebook"></i><span class="label">Facebook:</span>
        <a href="https://www.facebook.com/bangkhuang187" target="_blank"
          >facebook.com/bangkhuang187</a
        >
      </div>
      <div>
        <i class="fas fa-phone"></i><span class="label">Phone:</span> 0905640544
      </div>
      <div>
        <i class="fas fa-code-branch"></i><span class="label">Version:</span>
        0.1.7
      </div>
    </div>

    <!-- ========================================================================================================= -->
    <!--                                        JAVASCRIPT LOGIC                                                 -->
    <!-- ========================================================================================================= -->
    <script>
      // =========================================================================================================
      // ƒê·ªäNH NGHƒ®A BI·∫æN TO√ÄN C·ª§C V√Ä H√ÄM TR·ª¢ GI√öP
      // =========================================================================================================
      const DB_NAME = "LocketHuyDB";
      const DB_VERSION = 6; // TƒÉng phi√™n b·∫£n DB ƒë·ªÉ thay ƒë·ªïi logic ghi ch√∫
      let db;
      let allSubjects = [];
      let currentSubjectId = null;
      let currentNoteId = null;
      
      let draggedNoteId = null;

      // H√†m hi·ªÉn th·ªã th√¥ng b√°o t√πy ch·ªânh
      function showMessage(message) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.classList.add('visible');
        setTimeout(() => {
          messageBox.classList.remove('visible');
        }, 3000);
      }

      // H√†m hi·ªÉn th·ªã modal x√°c nh·∫≠n t√πy ch·ªânh
      function showConfirm(message, onConfirm) {
        const modal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        confirmMessage.textContent = message;
        modal.classList.add('visible');
        confirmYes.onclick = () => {
          modal.classList.remove('visible');
          onConfirm(true);
        };
        confirmNo.onclick = () => {
          modal.classList.remove('visible');
          onConfirm(false);
        };
      }

      // H√†m m·ªü v√† k·∫øt n·ªëi v·ªõi IndexedDB
      function openDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
          request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
          };
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // T·∫°o object store cho m√¥n h·ªçc n·∫øu ch∆∞a t·ªìn t·∫°i
            if (!db.objectStoreNames.contains("subjects")) {
              db.createObjectStore("subjects", {
                keyPath: "id",
                autoIncrement: true,
              });
            }

            // T·∫°o object store cho ghi ch√∫
            if (!db.objectStoreNames.contains("notes")) {
              const notesStore = db.createObjectStore("notes", {
                keyPath: "id",
                autoIncrement: true,
              });
              // T·∫°o index ƒë·ªÉ truy v·∫•n ghi ch√∫ theo subjectId
              notesStore.createIndex("subjectId", "subjectId", { unique: false });
            }
          };
        });
      }

      // H√†m l·∫•y object store t·ª´ transaction
      function getObjectStore(storeName, mode) {
        return db.transaction(storeName, mode).objectStore(storeName);
      }
      
      // H√†m chuy·ªÉn ƒë·ªïi ng√†y th√°ng th√†nh chu·ªói ƒë·ªãnh d·∫°ng ƒë·∫πp
      function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('vi-VN', options);
      }

      // =========================================================================================================
      // LOGIC QU·∫¢N L√ù M√îN H·ªåC (SIDEBAR)
      // =========================================================================================================
      
      // T·∫£i v√† hi·ªÉn th·ªã danh s√°ch m√¥n h·ªçc
      async function loadSubjects() {
        const subjectList = document.getElementById("subjectList");
        subjectList.innerHTML = "";
        try {
            const store = getObjectStore("subjects", "readonly");
            const request = store.getAll();
            request.onsuccess = (event) => {
                allSubjects = event.target.result;
                if (allSubjects.length === 0) {
                    subjectList.innerHTML = `<li style="text-align: center; font-style: italic; color: #888;">Ch∆∞a c√≥ m√¥n h·ªçc n√†o.</li>`;
                    currentSubjectId = null;
                    document.getElementById('mainTitle').textContent = "Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc";
                    document.getElementById('note-list-view').style.display = 'none';
                    document.getElementById('note-editor-view').style.display = 'none';
                    return;
                }
                
                allSubjects.forEach(subject => {
                    const subjectItem = createSubjectListItem(subject);
                    subjectList.appendChild(subjectItem);
                });

                // Ch·ªçn m√¥n h·ªçc ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥ m√¥n n√†o ƒë∆∞·ª£c ch·ªçn
                if (currentSubjectId) {
                    selectSubject(currentSubjectId);
                } else if (allSubjects.length > 0) {
                    selectSubject(allSubjects[0].id);
                }
            };
        } catch (e) {
            showMessage("L·ªói khi t·∫£i danh s√°ch m√¥n h·ªçc.");
        }
      }

      // T·∫°o m·ªôt item m√¥n h·ªçc trong sidebar
      function createSubjectListItem(subject) {
          const li = document.createElement("li");
          li.className = "subject-item";
          li.dataset.id = subject.id;
          li.innerHTML = `<span class="subject-name">${subject.name}</span><div class="subject-actions"></div>`;

          const actionsDiv = li.querySelector(".subject-actions");

          const editButton = document.createElement("button");
          editButton.innerHTML = `<i class="fas fa-edit"></i>`;
          editButton.onclick = (e) => {
              e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan truy·ªÅn l√™n li
              editSubject(subject.id, subject.name);
          };
          actionsDiv.appendChild(editButton);

          const deleteButton = document.createElement("button");
          deleteButton.innerHTML = `<i class="fas fa-trash-alt"></i>`;
          deleteButton.onclick = (e) => {
              e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan truy·ªÅn l√™n li
              deleteSubject(subject.id, subject.name);
          };
          actionsDiv.appendChild(deleteButton);

          li.onclick = () => selectSubject(subject.id);
          return li;
      }
      
      // Th√™m m·ªôt m√¥n h·ªçc m·ªõi
      async function addSubject() {
          const subjectName = "M√¥n h·ªçc m·ªõi";
          try {
              const store = getObjectStore("subjects", "readwrite");
              const request = store.add({ name: subjectName });
              request.onsuccess = (event) => {
                  showMessage("ƒê√£ th√™m m√¥n h·ªçc m·ªõi!");
                  loadSubjects();
              };
              request.onerror = () => showMessage("L·ªói khi th√™m m√¥n h·ªçc.");
          } catch (e) {
              showMessage("L·ªói khi th√™m m√¥n h·ªçc.");
          }
      }

      // Ch·ªânh s·ª≠a t√™n m√¥n h·ªçc
      let subjectToEdit = null;
      function editSubject(id, name) {
          subjectToEdit = { id, name };
          const modal = document.getElementById('editSubjectModal');
          const input = document.getElementById('editSubjectTitle');
          input.value = name;
          modal.classList.add('visible');
          input.focus();
      }

      // L∆∞u t√™n m√¥n h·ªçc ƒë√£ ch·ªânh s·ª≠a
      async function updateSubject() {
          if (!subjectToEdit) return;
          const newName = document.getElementById('editSubjectTitle').value.trim();
          if (newName) {
              try {
                  const store = getObjectStore("subjects", "readwrite");
                  const updatedSubject = { ...subjectToEdit, name: newName };
                  const request = store.put(updatedSubject);
                  request.onsuccess = () => {
                      document.getElementById('editSubjectModal').classList.remove('visible');
                      subjectToEdit = null;
                      showMessage("ƒê√£ c·∫≠p nh·∫≠t t√™n m√¥n h·ªçc.");
                      loadSubjects();
                  };
                  request.onerror = () => showMessage("L·ªói khi c·∫≠p nh·∫≠t t√™n m√¥n h·ªçc.");
              } catch (e) {
                  showMessage("L·ªói khi c·∫≠p nh·∫≠t t√™n m√¥n h·ªçc.");
              }
          } else {
              showMessage("T√™n m√¥n h·ªçc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
          }
      }

      // X√≥a m·ªôt m√¥n h·ªçc v√† t·∫•t c·∫£ ghi ch√∫ li√™n quan
      async function deleteSubject(id, name) {
          showConfirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc "${name}" v√† t·∫•t c·∫£ ghi ch√∫ c·ªßa n√≥ kh√¥ng?`, async (isConfirmed) => {
              if (isConfirmed) {
                  try {
                      // X√≥a t·∫•t c·∫£ ghi ch√∫ c·ªßa m√¥n h·ªçc n√†y
                      const notesStore = getObjectStore("notes", "readwrite");
                      const notesIndex = notesStore.index("subjectId");
                      const notesRequest = notesIndex.openCursor(IDBKeyRange.only(id));
                      notesRequest.onsuccess = (event) => {
                          const cursor = event.target.result;
                          if (cursor) {
                              notesStore.delete(cursor.value.id);
                              cursor.continue();
                          }
                      };

                      // X√≥a m√¥n h·ªçc
                      const subjectsStore = getObjectStore("subjects", "readwrite");
                      const subjectRequest = subjectsStore.delete(id);
                      subjectRequest.onsuccess = () => {
                          showMessage(`ƒê√£ x√≥a m√¥n h·ªçc "${name}".`);
                          loadSubjects();
                      };
                  } catch (e) {
                      showMessage("L·ªói khi x√≥a m√¥n h·ªçc.");
                  }
              }
          });
      }

      // Ch·ªçn m·ªôt m√¥n h·ªçc t·ª´ sidebar
      async function selectSubject(id) {
          currentSubjectId = id;
          currentNoteId = null; // Reset note ID
          
          // C·∫≠p nh·∫≠t tr·∫°ng th√°i active trong sidebar
          document.querySelectorAll('.subject-item').forEach(item => {
              item.classList.remove('active');
          });
          const activeSubjectItem = document.querySelector(`.subject-item[data-id='${id}']`);
          if (activeSubjectItem) {
              activeSubjectItem.classList.add('active');
          }

          loadNotesForCurrentSubject();
      }

      // =========================================================================================================
      // LOGIC QU·∫¢N L√ù GHI CH√ö
      // =========================================================================================================

      // T·∫£i v√† hi·ªÉn th·ªã danh s√°ch ghi ch√∫ cho m√¥n h·ªçc hi·ªán t·∫°i
      async function loadNotesForCurrentSubject() {
          if (!currentSubjectId) return;
          
          const selectedSubject = allSubjects.find(s => s.id === currentSubjectId);
          document.getElementById('mainTitle').textContent = `Ghi ch√∫ cho m√¥n: ${selectedSubject.name}`;
          document.getElementById('note-list-view').style.display = 'block';
          document.getElementById('note-editor-view').style.display = 'none';

          const noteListContainer = document.getElementById('noteList');
          noteListContainer.innerHTML = "";
          
          try {
            const store = getObjectStore("notes", "readonly");
            const index = store.index("subjectId");
            const request = index.getAll(IDBKeyRange.only(currentSubjectId));
            
            request.onsuccess = (event) => {
              const notes = event.target.result;
              if (notes.length === 0) {
                  noteListContainer.innerHTML = `<p style="text-align: center; font-style: italic; color: #888;">Ch∆∞a c√≥ ghi ch√∫ n√†o. H√£y th√™m m·ªôt c√°i!</p>`;
                  return;
              }
              // S·∫Øp x·∫øp c√°c ghi ch√∫ theo tr∆∞·ªùng 'position' (n·∫øu c√≥)
              notes.sort((a, b) => (a.position || 0) - (b.position || 0));
              notes.forEach(note => {
                  const noteItem = createNoteListItem(note);
                  noteListContainer.appendChild(noteItem);
              });
            };
            request.onerror = () => showMessage("L·ªói khi t·∫£i danh s√°ch ghi ch√∫.");
          } catch (e) {
            showMessage("L·ªói khi t·∫£i danh s√°ch ghi ch√∫.");
          }
      }

      // T·∫°o m·ªôt item ghi ch√∫ trong danh s√°ch
      function createNoteListItem(note) {
          const div = document.createElement("div");
          div.className = "note-list-item";
          div.dataset.id = note.id;
          div.setAttribute('draggable', true); // Th√™m thu·ªôc t√≠nh draggable
          div.onclick = () => openNote(note.id);
          div.innerHTML = `
              <div>
                  <h4>${note.title || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ"}</h4>
                  <p>${note.content.substring(0, 100) || "Kh√¥ng c√≥ n·ªôi dung"}</p>
              </div>
              <span class="date">${formatDate(note.timestamp)}</span>
          `;
          return div;
      }
      
      // M·ªü tr√¨nh ch·ªânh s·ª≠a ƒë·ªÉ t·∫°o ghi ch√∫ m·ªõi
      function createNewNote() {
          if (!currentSubjectId) {
              showMessage("Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc tr∆∞·ªõc.");
              return;
          }
          currentNoteId = null;
          document.getElementById('noteTitle').value = "";
          document.getElementById('noteContent').value = "";
          document.getElementById('mainTitle').textContent = "T·∫°o ghi ch√∫ m·ªõi";
          document.getElementById('note-list-view').style.display = 'none';
          document.getElementById('note-editor-view').style.display = 'block';
          document.getElementById('noteTitle').focus();
      }

      // M·ªü tr√¨nh ch·ªânh s·ª≠a ƒë·ªÉ xem/s·ª≠a ghi ch√∫ ƒë√£ c√≥
      async function openNote(noteId) {
          if (!currentSubjectId) return;
          
          try {
            const store = getObjectStore("notes", "readonly");
            const request = store.get(noteId);
            
            request.onsuccess = (event) => {
              const note = event.target.result;
              if (note) {
                  currentNoteId = note.id;
                  document.getElementById('noteTitle').value = note.title;
                  document.getElementById('noteContent').value = note.content;
                  document.getElementById('mainTitle').textContent = `Ch·ªânh s·ª≠a: ${note.title || "Ghi ch√∫ kh√¥ng ti√™u ƒë·ªÅ"}`;
                  document.getElementById('note-list-view').style.display = 'none';
                  document.getElementById('note-editor-view').style.display = 'block';
              }
            };
            request.onerror = () => showMessage("Kh√¥ng th·ªÉ m·ªü ghi ch√∫.");
          } catch (e) {
            showMessage("L·ªói khi m·ªü ghi ch√∫.");
          }
      }

      // L∆∞u ghi ch√∫ (m·ªõi ho·∫∑c ƒë√£ c√≥)
      async function saveNote() {
          if (!currentSubjectId) {
              showMessage("Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc tr∆∞·ªõc.");
              return;
          }
          const title = document.getElementById('noteTitle').value.trim();
          const content = document.getElementById('noteContent').value.trim();
          
          if (!title && !content) {
              showMessage("Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ l∆∞u.");
              return;
          }

          try {
              const store = getObjectStore("notes", "readwrite");
              
              if (currentNoteId) {
                  // C·∫≠p nh·∫≠t ghi ch√∫ ƒë√£ c√≥
                  const getRequest = store.get(currentNoteId);
                  getRequest.onsuccess = (event) => {
                      const existingNote = event.target.result;
                      if (existingNote) {
                          existingNote.title = title;
                          existingNote.content = content;
                          existingNote.timestamp = new Date().toISOString();
                          const putRequest = store.put(existingNote);
                          putRequest.onsuccess = () => {
                              showMessage("ƒê√£ c·∫≠p nh·∫≠t ghi ch√∫!");
                              loadNotesForCurrentSubject();
                          };
                      }
                  };
              } else {
                  // T·∫°o ghi ch√∫ m·ªõi
                  const allNotesForSubject = await new Promise((resolve, reject) => {
                      const req = store.index("subjectId").getAll(IDBKeyRange.only(currentSubjectId));
                      req.onsuccess = () => resolve(req.result);
                      req.onerror = () => reject(req.error);
                  });
                  const newPosition = allNotesForSubject.length > 0 ? Math.max(...allNotesForSubject.map(n => n.position || 0)) + 1 : 1;
                  
                  const noteToSave = {
                      subjectId: currentSubjectId,
                      title: title,
                      content: content,
                      timestamp: new Date().toISOString(),
                      position: newPosition, // Th√™m tr∆∞·ªùng position cho vi·ªác s·∫Øp x·∫øp
                  };
                  const addRequest = store.add(noteToSave);
                  addRequest.onsuccess = () => {
                      showMessage("ƒê√£ l∆∞u ghi ch√∫ m·ªõi!");
                      loadNotesForCurrentSubject();
                  };
              }
          } catch (e) {
              showMessage("L·ªói khi l∆∞u ghi ch√∫.");
          }
      }

      // X√≥a ghi ch√∫ hi·ªán t·∫°i
      async function deleteNote() {
          if (!currentNoteId) {
              showMessage("Kh√¥ng c√≥ ghi ch√∫ n√†o ƒë·ªÉ x√≥a.");
              return;
          }
          
          showConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?", async (isConfirmed) => {
              if (isConfirmed) {
                  try {
                      const store = getObjectStore("notes", "readwrite");
                      const request = store.delete(currentNoteId);
                      request.onsuccess = () => {
                          showMessage("ƒê√£ x√≥a ghi ch√∫!");
                          currentNoteId = null;
                          loadNotesForCurrentSubject();
                      };
                      request.onerror = () => showMessage("L·ªói khi x√≥a ghi ch√∫.");
                  } catch (e) {
                      showMessage("L·ªói khi x√≥a ghi ch√∫.");
                  }
              }
          });
      }

      // C·∫≠p nh·∫≠t th·ª© t·ª± c√°c ghi ch√∫ sau khi k√©o th·∫£
      async function updateNotePositions(notesToUpdate) {
        try {
            const transaction = db.transaction("notes", "readwrite");
            const store = transaction.objectStore("notes");
            
            for (const note of notesToUpdate) {
                const getRequest = store.get(note.id);
                getRequest.onsuccess = (event) => {
                    const existingNote = event.target.result;
                    if (existingNote) {
                        existingNote.position = note.position;
                        store.put(existingNote);
                    }
                };
            }

            transaction.oncomplete = () => {
                showMessage("ƒê√£ c·∫≠p nh·∫≠t th·ª© t·ª± ghi ch√∫.");
            };
            transaction.onerror = () => showMessage("L·ªói khi c·∫≠p nh·∫≠t th·ª© t·ª±.");
        } catch (e) {
            showMessage("L·ªói khi c·∫≠p nh·∫≠t th·ª© t·ª±.");
        }
      }

      // =========================================================================================================
      // C√ÅC H√ÄNH ƒê·ªòNG V√Ä S·ª∞ KI·ªÜN KH√ÅC
      // =========================================================================================================

      // Icon c·ªè ba l√° (ƒë·ªÉ k√©o)
      const cloverIcon = document.getElementById("clover-reload-icon");
      let isDragging = false;
      let offsetX, offsetY;

      cloverIcon.addEventListener("mousedown", (e) => {
        isDragging = true;
        cloverIcon.style.cursor = "grabbing";
        offsetX = e.clientX - cloverIcon.getBoundingClientRect().left;
        offsetY = e.clientY - cloverIcon.getBoundingClientRect().top;
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        cloverIcon.style.left = e.clientX - offsetX + "px";
        cloverIcon.style.top = e.clientY - offsetY + "px";
      });

      document.addEventListener("mouseup", () => {
        if (!isDragging) return;
        isDragging = false;
        cloverIcon.style.cursor = "grab";
      });

      // L·∫Øng nghe c√°c s·ª± ki·ªán k√©o th·∫£ tr√™n danh s√°ch ghi ch√∫
      const noteList = document.getElementById('noteList');
      noteList.addEventListener('dragstart', (e) => {
          if (e.target.classList.contains('note-list-item')) {
              draggedNoteId = e.target.dataset.id;
              e.target.classList.add('dragging');
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/plain', draggedNoteId);
          }
      });
      noteList.addEventListener('dragend', (e) => {
          e.target.classList.remove('dragging');
          // X√≥a t·∫•t c·∫£ c√°c l·ªõp drag-over
          document.querySelectorAll('.note-list-item').forEach(item => {
              item.classList.remove('drag-over', 'drag-over-bottom');
          });
      });
      noteList.addEventListener('dragover', (e) => {
          e.preventDefault(); // Cho ph√©p th·∫£
          const draggedItem = document.querySelector('.note-list-item.dragging');
          const dropTarget = e.target.closest('.note-list-item');
          if (draggedItem && dropTarget && draggedItem !== dropTarget) {
              const rect = dropTarget.getBoundingClientRect();
              const centerY = rect.top + rect.height / 2;
              
              // X√≥a c√°c l·ªõp drag-over c≈© ƒë·ªÉ ch·ªâ c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c highlight
              document.querySelectorAll('.note-list-item').forEach(item => {
                  item.classList.remove('drag-over', 'drag-over-bottom');
              });

              if (e.clientY < centerY) {
                  dropTarget.classList.add('drag-over');
              } else {
                  dropTarget.classList.add('drag-over-bottom');
              }
          }
      });
      noteList.addEventListener('drop', (e) => {
          e.preventDefault();
          const draggedItem = document.querySelector('.note-list-item.dragging');
          const dropTarget = e.target.closest('.note-list-item');

          if (draggedItem && dropTarget && draggedItem !== dropTarget) {
              const rect = dropTarget.getBoundingClientRect();
              const centerY = rect.top + rect.height / 2;
              
              const isDropBefore = e.clientY < centerY;

              if (isDropBefore) {
                  noteList.insertBefore(draggedItem, dropTarget);
              } else {
                  noteList.insertBefore(draggedItem, dropTarget.nextSibling);
              }
              
              // C·∫≠p nh·∫≠t v·ªã tr√≠ trong IndexedDB
              const updatedNotes = Array.from(noteList.children).map((item, index) => ({
                  id: parseInt(item.dataset.id),
                  position: index + 1,
              }));
              updateNotePositions(updatedNotes);
          }

          // X√≥a t·∫•t c·∫£ c√°c l·ªõp drag-over sau khi th·∫£
          document.querySelectorAll('.note-list-item').forEach(item => {
              item.classList.remove('drag-over', 'drag-over-bottom');
          });
      });
      
      // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t trong modal ch·ªânh s·ª≠a t√™n m√¥n h·ªçc
      document.getElementById('saveEditSubjectButton').addEventListener('click', updateSubject);
      document.getElementById('cancelEditSubjectButton').addEventListener('click', () => {
          document.getElementById('editSubjectModal').classList.remove('visible');
          subjectToEdit = null;
      });

      // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi DOM ƒë√£ t·∫£i xong
      window.addEventListener("DOMContentLoaded", async () => {
        await openDB();
        loadSubjects();
      });
    </script>
  </body>
</html>
