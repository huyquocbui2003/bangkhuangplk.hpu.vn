<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sửa bài viết</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #d81b60;
        --secondary-color: #ff80ab;
        --background-light: #e0f7fa;
        --background-dark: #fce4ec;
        --text-color: #333;
        --card-bg: #fff;
        --border-radius-large: 10px;
        --border-radius-small: 6px;
        --box-shadow-main: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(
          135deg,
          var(--background-light),
          var(--background-dark)
        );
        margin: 0;
        padding: 0;
        color: var(--text-color);
      }

      .home-button {
        position: fixed;
        top: 20px;
        left: 20px;
        display: flex;
        align-items: center;
        background: linear-gradient(to right, var(--secondary-color), #f48fb1);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        z-index: 1000;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
      }
      .home-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      .container {
        max-width: 600px;
        margin: 80px auto 20px;
        background: var(--card-bg);
        padding: 30px;
        border-radius: var(--border-radius-large);
        box-shadow: var(--box-shadow-main);
        text-align: center;
      }

      h2 {
        color: var(--primary-color);
        margin-bottom: 20px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius-small);
        box-sizing: border-box;
      }

      #edit-content {
        width: 100%;
        min-height: 200px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius-small);
        box-sizing: border-box;
        text-align: left;
        background: #fdfdfd;
        cursor: text;
        outline: none;
      }

      .toolbar {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .toolbar button {
        padding: 8px 12px;
        background: #fce4ec; /* Nền hồng nhạt */
        border: 1px solid #f8bbd0; /* Viền hồng */
        border-radius: var(--border-radius-small);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: bold;
        color: var(--primary-color); /* Chữ màu hồng đậm */
      }

      .toolbar button:hover {
        background: #f48fb1; /* Nền hồng đậm hơn khi di chuột */
        color: white; /* Chữ trắng khi di chuột */
        transform: translateY(-1px);
      }
      
      .toolbar button i {
        font-size: 1.2em;
      }

      .button-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
      }

      button.save-button,
      button.cancel-button {
        padding: 12px 24px;
        background: linear-gradient(to right, var(--secondary-color), #f48fb1);
        color: white;
        border: none;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      button.save-button:hover,
      button.cancel-button:hover {
        background: linear-gradient(to right, var(--primary-color), #f06292);
        transform: translateY(-2px);
      }

      button i {
        margin-right: 8px;
      }

      label {
        color: var(--text-color);
      }

      footer {
        margin-top: 40px;
        padding: 20px;
        background: linear-gradient(90deg, #ffe0f0, #e0f7fa);
        font-size: 14px;
        color: #444;
        border-top: 1px solid #ddd;
        text-align: center;
        border-radius: var(--border-radius-large);
      }

      footer a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: bold;
      }

      footer a:hover {
        text-decoration: underline;
      }

      footer .label {
        color: #888;
        font-weight: normal;
      }

      footer i {
        margin-right: 5px;
        color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <a href="giaodien.html" class="home-button">
      <i class="fas fa-home"></i> Trở về
    </a>

    <div class="container">
      <h2>Sửa bài viết</h2>
      <input type="text" id="edit-title" placeholder="Tiêu đề bài viết" />

      <div class="toolbar">
        <button id="bold-btn" title="Bôi đậm (Ctrl+B)">
          <b>B</b>
        </button>
        <button id="italic-btn" title="In nghiêng (Ctrl+I)">
          <i>I</i>
        </button>
        <button id="underline-btn" title="Gạch chân (Ctrl+U)">
          <u>U</u>
        </button>
        <button id="highlight-btn" title="Tô sáng">
          <i class="fas fa-highlighter"></i>
        </button>
      </div>

      <div
        id="edit-content"
        contenteditable="true"
        placeholder="Nội dung bài viết"
      ></div>

      <label>
        <input type="checkbox" id="edit-completed" /> Đánh dấu đã hoàn thành
      </label>
      <div class="button-group">
        <button class="save-button" onclick="saveChanges()">
          <i class="fas fa-save"></i> Lưu
        </button>
        <button class="cancel-button" onclick="cancelEdit()">
          <i class="fas fa-times"></i> Hủy
        </button>
      </div>
    </div>

    <footer>
      <div>
        <i class="fas fa-user"></i
        ><span class="label">Website created by:</span> Bùi Quốc Huy
      </div>
      <div>
        <i class="fab fa-facebook"></i><span class="label">Facebook:</span>
        <a href="https://www.facebook.com/bangkhuang187" target="_blank"
          >facebook.com/bangkhuang187</a
        >
      </div>
      <div>
        <i class="fas fa-phone"></i><span class="label">Phone:</span> 0905640544
      </div>
      <div>
        <i class="fas fa-code-branch"></i
        ><span class="label">Version:</span> 0.0.5 (Cập nhật)
      </div>
    </footer>

    <script>
      // IndexedDB Helper Functions
      const DB_NAME = "LocketHuyDB";
      const DB_VERSION = 1;
      let db;

      async function openDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onerror = (event) =>
            reject("IndexedDB error: " + event.target.errorCode);
          request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
          };
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("statuses")) {
              db.createObjectStore("statuses", {
                keyPath: "id",
                autoIncrement: true,
              });
            }
          };
        });
      }

      async function saveToDB(storeName, data) {
        if (!db) await openDB();
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        store.put(data);
        return new Promise((resolve, reject) => {
          transaction.oncomplete = () => resolve();
          transaction.onerror = (event) => reject(event.target.error);
        });
      }

      async function getByIdFromDB(storeName, id) {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction([storeName], "readonly");
          const store = transaction.objectStore(storeName);
          const request = store.get(id);
          request.onsuccess = (event) => resolve(event.target.result);
          request.onerror = (event) => reject(event.target.error);
        });
      }

      let statusId = null;
      let oldStatus = {};
      const editContent = document.getElementById("edit-content");

      async function loadStatus() {
        const params = new URLSearchParams(window.location.search);
        statusId = parseInt(params.get("id"));

        if (isNaN(statusId)) {
          alert("Không tìm thấy ID bài viết!");
          window.location.href = "giaodien.html";
          return;
        }

        oldStatus = await getByIdFromDB("statuses", statusId);

        if (oldStatus) {
          document.getElementById("edit-title").value = oldStatus.title;
          editContent.innerHTML = oldStatus.content;
          document.getElementById("edit-completed").checked =
            oldStatus.completed;
        } else {
          alert("Không tìm thấy bài viết để sửa!");
          window.location.href = "giaodien.html";
        }
      }

      async function saveChanges() {
        const newTitle = document.getElementById("edit-title").value;
        const newContent = editContent.innerHTML;
        const newCompleted = document.getElementById("edit-completed").checked;

        if (
          newTitle === oldStatus.title &&
          newContent === oldStatus.content &&
          newCompleted === oldStatus.completed
        ) {
          alert("Không có thay đổi nào để lưu!");
          return;
        }

        const updatedStatus = { ...oldStatus };
        updatedStatus.title = newTitle;
        updatedStatus.content = newContent;
        updatedStatus.completed = newCompleted;

        if (!updatedStatus.history) {
            updatedStatus.history = [];
        }
        updatedStatus.history.push({
          editedAt: new Date(),
          oldTitle: oldStatus.title,
          newTitle: newTitle,
          oldContent: oldStatus.content,
          newContent: newContent,
        });

        await saveToDB("statuses", updatedStatus);
        alert("Đã lưu thay đổi!");
        window.location.href = "giaodien.html";
      }

      function cancelEdit() {
        window.location.href = "giaodien.html";
      }

      function applyFormat(command, value = null) {
        document.execCommand(command, false, value);
        editContent.focus();
      }

      // Toolbar event listeners
      document.getElementById("bold-btn").addEventListener("click", () => applyFormat("bold"));
      document.getElementById("italic-btn").addEventListener("click", () => applyFormat("italic"));
      document.getElementById("underline-btn").addEventListener("click", () => applyFormat("underline"));
      document.getElementById("highlight-btn").addEventListener("click", () => applyFormat("backColor", "yellow"));

      window.addEventListener("DOMContentLoaded", async () => {
        await openDB();
        loadStatus();
      });
    </script>
  </body>
</html>
